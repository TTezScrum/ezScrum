*** Settings ***
Library           ../lib/Selenium2Improved.py
Library           Collections
Resource          ../../Global Define.txt
Resource          ../../ServerConfig.txt
Resource          ../common_resource.txt
Resource          ../Project/ezScrum_Project.txt
Resource          ../ezScrum_Login.txt
Resource          ezScrum_Retrospective.txt

*** Keywords ***
_Login
    [Documentation]    過渡時期做法
    Maximize Browser Window
    Set Selenium Speed    ${SELENIUM_SPEED}
    Input Text    userId    admin
    Input Password    password    admin
    Submit Form    logonForm
    Title Should Be    ezScrum, SSLab NTUT

_Logout
    Click Image    images/logout.gif
    Title Should Be    ezScrum Logon!

Test Retrospective Suite Setup
    Comment    Close All Browsers
    Comment    Open Browser    ${LOGIN_URL}    ${BROWSER}

Test Retrospective Suite Teardown
    Comment    Close Browser
    Comment    Close All Browsers

Test Retrospective Add Setup
    Comment    _Login
    Comment    # 確認專案是否存在
    Comment    Wait Until Page Contains Element    createProjectBtn
    Comment    ${_IsProjectIDExisted}=    Check ProjectID Is Existed    ${PROJECT_NAME}
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="false"    Create Project
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="true"    Select Project    ${PROJECT_NAME}DisplayName
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Retrospective    Add_Retrospective.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    Select Project    localtestProjectDisplayName
    Select Project Management Item    Sprint Plan
    #    SwitchToItemLink    True    Sprint Plan
    ${_sprintGoal} =    Set Variable    test sprint Goal
    ${sprintID}=    Get Text    //div[@id="SprintPlan_Page_Layout"]//div/table/tbody/tr//td/div[text()="${_sprintGoal}"]/../../td[1]/div
    Set List Value    ${tsSprintInfo}    0    ${_sprintID}
    Set List Value    ${tsRetrospectiveList}    2    ${_sprintID}
    # 切換到 Retrospective 頁面
    #    SwitchToItemLink    True    Retrospective
    Select Project Management Item    Retrospective

Test Retrospective Add Teardown
    Comment    Clean All Retrospective
    Comment    SwitchToItemLink    True    Sprint Plan
    Comment    Clean All Sprint
    Comment    _Logout
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Retrospective Edit Setup
    Comment    _Login
    Comment    # 確認專案是否存在
    Comment    Wait Until Page Contains Element    createProjectBtn
    Comment    ${_IsProjectIDExisted}=    Check ProjectID Is Existed    ${PROJECT_NAME}
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="false"    Create Project
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="true"    Select Project    ${PROJECT_NAME}DisplayName
    Comment    # 新增 Sprint
    Comment    Select Project Management Item    Sprint Plan
    Comment    ${_sprintID} =    New Sprint    @{tsSprintInfo}
    Comment    Set List Value    ${tsSprintInfo}    0    ${_sprintID}
    Comment    Set List Value    ${tsRetrospectiveList}    2    ${_sprintID}
    Comment    # 切換到 Retrospective 頁面
    Comment    Select Project Management Item    Retrospective
    Comment    Add Retrospective    @{tsRetrospectiveList}
    Comment    ${_newID} =    Get Retrospective ID    True    0
    Comment    Set List Value    ${tsRetrospectiveList}    0    ${_newID}
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Retrospective    Edit_Retrospective.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    Select Project    localtestProjectDisplayName
    Select Project Management Item    Sprint Plan
    #    SwitchToItemLink    True    Sprint Plan
    ${_sprintGoal} =    Set Variable    test sprint Goal
    ${sprintID}=    Get Text    //div[@id="SprintPlan_Page_Layout"]//div/table/tbody/tr//td/div[text()="${_sprintGoal}"]/../../td[1]/div
    Set List Value    ${tsSprintInfo}    0    ${_sprintID}
    Set List Value    ${tsRetrospectiveList}    2    ${_sprintID}
    # 切換到 Retrospective 頁面
    #    SwitchToItemLink    True    Retrospective
    Select Project Management Item    Retrospective
    ${_newID} =    Get Retrospective ID    True    0
    Set List Value    ${tsRetrospectiveList}    0    ${_newID}

Test Retrospective Edit Teardown
    Comment    Clean All Retrospective
    Comment    SwitchToItemLink    True    Sprint Plan
    Comment    Clean All Sprint
    Comment    _Logout
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Retrospective Delete Setup
    Comment    _Login
    Comment    # 確認專案是否存在
    Comment    Wait Until Page Contains Element    createProjectBtn
    Comment    ${_IsProjectIDExisted}=    Check ProjectID Is Existed    ${PROJECT_NAME}
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="false"    Create Project
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="true"    Select Project    ${PROJECT_NAME}DisplayName
    Comment    # 新增 Sprint
    Comment    Select Project Management Item    Sprint Plan
    Comment    ${_sprintID} =    New Sprint    @{tsSprintInfo}
    Comment    Set List Value    ${tsSprintInfo}    0    ${_sprintID}
    Comment    Set List Value    ${tsRetrospectiveList}    2    ${_sprintID}
    Comment    # 切換到 Retrospective 頁面
    Comment    Select Project Management Item    Retrospective
    Comment    Add Retrospective    @{tsRetrospectiveList}
    Comment    ${_newID} =    Get Retrospective ID    True    0
    Comment    Set List Value    ${tsRetrospectiveList}    0    ${_newID}
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Retrospective    Delete_Retrospective.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    Select Project    localtestProjectDisplayName
    Select Project Management Item    Sprint Plan
    #    SwitchToItemLink    True    Sprint Plan
    ${_sprintGoal} =    Set Variable    test sprint Goal
    ${sprintID}=    Get Text    //div[@id="SprintPlan_Page_Layout"]//div/table/tbody/tr//td/div[text()="${_sprintGoal}"]/../../td[1]/div
    Set List Value    ${tsSprintInfo}    0    ${_sprintID}
    Set List Value    ${tsRetrospectiveList}    2    ${_sprintID}
    # 切換到 Retrospective 頁面
    #    SwitchToItemLink    True    Retrospective
    Select Project Management Item    Retrospective
    ${_newID} =    Get Retrospective ID    True    0
    Set List Value    ${tsRetrospectiveList}    0    ${_newID}

Test Retrospective Delete Teardown
    Comment    Clean All Retrospective
    Comment    SwitchToItemLink    True    Sprint Plan
    Comment    Clean All Sprint
    Comment    _Logout
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Exit ezScrum System

Test Retrospective Edit Multiple Setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Retrospective    Edit_Several_Retrospective.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    Select Project    localtestProjectDisplayName
