*** Settings ***
Library           ../lib/Selenium2Improved.py
Resource          ../common_resource.txt

*** Keywords ***
Task Checked Out With Arguments
    [Arguments]    ${_StoryID}    ${_TaskID}
    Wait Until Page Contains Element    xpath=//div[@id="${_StoryID}_new"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${_TaskID}"]/../../../../../../../..
    Wait Until Page Contains Element    xpath=//div[@id="${_StoryID}_assigned"]/div
    Assign Id To Element    xpath=//div[@id="${_StoryID}_assigned"]/div    checkedOutStageID
    Click Element    checkedOutStageID
    Drag And Drop    xpath=//div[@id="${_StoryID}_new"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${_TaskID}"]/../../../../../../../..    target=checkedOutStageID
    Comment    Wait Until Page Contains    Check Out Task
    Comment    ${_XpathCheckOutTask}=    Find Current Window Element    Check Out Task    Check Out
    Comment    Element Enable And Submit    ${_XpathCheckOutTask}
    Click Element    xpath=//button[text()="Check Out"]
    Wait Until Page Contains    Success.

Task Done With Arguments
    [Arguments]    ${_StoryID}    ${_TaskID}
    Click Element    xpath=//div[@id="${_StoryID}_closed"]
    Drag And Drop    xpath=//div[@id="${_StoryID}_assigned"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${_TaskID}"]    target=${_StoryID}_closed
    Click Element    xpath=//button[text()="Done"]
    Wait Until Page Contains    Success.

Task ReOpen With Arguments
    [Arguments]    ${_StoryID}    ${_TaskID}
    Drag And Drop    xpath=//div[@id="${_StoryID}_closed"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${_TaskID}"]/../../../../../../../..    target=${_StoryID}_assigned
    Comment    Wait Until Page Contains    Re Opened Issue
    Comment    ${_XpathReOpenTask}=    Find Current Window Element    Re Opened Issue    Re Open
    Comment    Element Enable And Submit    ${_XpathReOpenTask}
    Wait Until Element Is Visible    xpath=//button[text()="Re Open"]    1 min
    Click Element    xpath=//button[text()="Re Open"]
    Wait Until Page Contains    Success.

Task ReChecked Out With Arguments
    [Arguments]    ${_StoryID}    ${_TaskID}
    Drag And Drop    xpath=//div[@id="${_StoryID}_assigned"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${_TaskID}"]/../../../../../../../..    target=${_StoryID}_new
    Comment    Wait Until Page Contains    Reset Checked Out Task
    Comment    ${_XpathResetCheckOutTask}=    Find Current Window Element    Reset Checked Out Task    Reset Check Out
    Comment    Element Enable And Submit    ${_XpathResetCheckOutTask}
    Click Element    xpath=//button[text()="Reset Check Out"]
    Wait Until Page Contains    Success.

Story Done With Arguments
    [Arguments]    ${_StoryID}
    Drag And Drop    xpath=//*[@id="Story:${_StoryID}"]    target=${_StoryID}_closed
    Comment    Wait Until Page Contains    Done Story
    Comment    ${_XpathDoneStory}=    Find Current Window Element    Done Story #${_StoryID}    Done
    Comment    Element Enable And Submit    ${_XpathDoneStory}
    Click Element    xpath=//button[text()="Done"]
    Wait Until Page Contains    Success.

Story ReOpen With Arguments
    [Arguments]    ${_StoryID}
    Drag And Drop    xpath=//div[@id="${_StoryID}_closed"]//table[@class="StoryCard_Header"]//td[1]/h2[text()="[Story]\ \ #${_StoryID}"]/../../../../../../../..    target=${_StoryID}_new
    Comment    Wait Until Page Contains    Re Opened Issue
    Comment    ${_XpathReOpenStory}=    Find Current Window Element    Re Opened Issue    Re Open
    Comment    Element Enable And Submit    ${_XpathReOpenStory}
    Click Element    xpath=//button[text()="Re Open"]
    Wait Until Page Contains    Success.

Verify Story Information With Arguments In TaskBoard
    [Arguments]    ${_StoryID}    ${_StoryName}    ${_StoryValue}    ${_StoryEstimate}    ${_StoryImportance}    ${tagName}
    ...    ${_StoryNotes}    ${_StoryHowToDemo}
    Click Element    xpath=//div[@id="TaskBoard_Page"]//div[@id="${_StoryID}_new"]//a[@title="Edit the Story"]
    Compare Field Content    //textarea[@name="Name"]    ${_StoryName}
    Compare Field Content    //input[@name="Value"]    ${_StoryValue}
    Compare Field Content    //input[@name="Estimate"]    ${_StoryEstimate}
    Compare Field Content    //input[@name="Importance"]    ${_StoryImportance}
    Compare Field Content    //textarea[@name="Notes"]    ${_StoryNotes}
    Compare Field Content    //input[@name="Tags"]    ${tagName}
    Compare Field Content    //textarea[@name="HowToDemo"]    ${_StoryHowToDemo}
    ${_XpathEditStoryCancel}=    Find Current Window Element    Edit Story #${_StoryID}    Cancel
    Element Enable And Submit    ${_XpathEditStoryCancel}

Verify Task Information With Arguments In TaskBoard
    [Arguments]    ${_TaskID}    ${_TaskName}    ${_TaskHandler}    ${_TaskPartners}    ${_TaskEstimate}    ${_TaskRemains}
    ...    ${_TaskActual}    ${_TaskNotes}
    Click Element    xpath=//div[@id="TaskBoard_Page"]//div[@id="${tcStoryID}_new"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${_TaskID}"]/../..//a[@title="Edit the Task"]
    Compare Field Content    //span[text()="Edit Task #${_TaskID}"]/../../../../../div[@class="x-window-bwrap"]//input[@name="Name"]    ${_TaskName}
    Compare Field Content    //span[text()="Edit Task #${_TaskID}"]/../../../../../div[@class="x-window-bwrap"]//input[@name="HandlerComboBox_ForEditTask"]    ${_TaskHandler}
    Compare Field Content    //span[text()="Edit Task #${_TaskID}"]/../../../../../div[@class="x-window-bwrap"]//input[@name="Partners"]    ${_TaskPartners}
    Compare Field Content    //span[text()="Edit Task #${_TaskID}"]/../../../../../div[@class="x-window-bwrap"]//input[@name="Estimate"]    ${_TaskEstimate}
    Compare Field Content    //span[text()="Edit Task #${_TaskID}"]/../../../../../div[@class="x-window-bwrap"]//input[@name="Remains"]    ${_TaskRemains}
    Compare Field Content    //span[text()="Edit Task #${_TaskID}"]/../../../../../div[@class="x-window-bwrap"]//input[@name="Actual"]    ${_TaskActual}
    Compare Field Content    //span[text()="Edit Task #${_TaskID}"]/../../../../../div[@class="x-window-bwrap"]//textarea[@name="Notes"]    ${_TaskNotes}
    ${_XpathEditStoryCancel}=    Find Current Window Element    Edit Task #${_TaskID}    Cancel
    Element Enable And Submit    ${_XpathEditStoryCancel}

Move Task From Check Out To Done
    [Arguments]    ${Story_ID}    ${Task_number}
    Click Element    xpath=//div[@id="${Story_ID}_closed"]
    Drag and Drop    xpath=//div[@id="${Story_ID}_assigned"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${Task_number}"]    target=${Story_ID}_closed
    Wait Until Page Contains Element    xpath=//tr//button[text()="Done"]
    Click Element    xpath=//tr//button[text()="Done"]

Check if Done column has TaskCard
    [Arguments]    ${Story_ID}    ${TaskNumber}
    Wait until Page Contains Element    xpath=//table[@class="TaskCard_Table"]
    Page Should Contain Element    xpath=//div[@id="${Story_ID}_closed"]//h2[text()="[Task] \ #${Task_number}"]    message=#${TaskNumber} taskcard doesn't in the done column

Move Task From Check Out To Done Check ID Before Click Done
    [Arguments]    ${Story_ID}    ${Task_ID}    ${initialTaskName}
    Click Element    //table[@class="x-table-layout"]//div[@id="${Story_ID}_closed"]
    Drag and Drop    xpath=//div[@id="${Story_ID}_assigned"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${Task_ID}"]    target=${Story_ID}_closed
    ${windowTaskName}=    Get Value    //input[@name="Id"]/../div[1]/div/input
    Should Be Equal    ${windowTaskName}    ${initialTaskName}
    ${windowTital}=    Set Variable    //div[@class="x-window-tl"]//span[text()="Done Task #${Task_ID}"]
    Compare Text In Specific Xpath    ${windowTital}    Done Task #${Task_ID}
    Click Element    xpath=//button[text()="Done"]

Check TaskCard Contents
    [Arguments]    ${TaskCardID}    ${TaskCardContent}    ${TaskCardHandler}    ${TaskCardHours}
    ${FetchTaskCardID}=    Get Text    //div[@id="Task:${TaskCardID}"]//table[@class="TaskCard_Header"]
    ${FetchTaskCardID}=    Fetch From Right    ${FetchTaskCardID}    \#
    Should Be Equal    ${FetchTaskCardID}    ${TaskCardID}
    ${FetchTaskCardContent}=    Get Text    //div[@id="Task:${TaskCardID}"]//td[@class="TaskCard_Description"]
    Should Be Equal    ${FetchTaskCardContent}    ${TaskCardContent}
    ${FetchTaskCardHandler}=    Get Text    //div[@id="Task:${TaskCardID}"]//span[@class="TaskCard_Handler"]
    Should Be Equal    ${FetchTaskCardHandler}    ${TaskCardHandler}
    ${FetchTaskCardHours}=    Get Text    //div[@id="Task:${TaskCardID}"]//td[@class="TaskCard_Value"]
    Should Be Equal    ${FetchTaskCardHours}    ${TaskCardHours}

Move Task From Not Check Out To Check Out Check ID Before Click Done
    [Arguments]    ${Story_ID}    ${Task_ID}    ${initialTaskName}
    Click Element    //table[@class="x-table-layout"]//div[@id="${Story_ID}_closed"]
    Drag and Drop    xpath=//div[@id="${Story_ID}_new"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${Task_ID}"]    target=${Story_ID}_assigned
    ${windowTaskName}=    Get Value    //input[@name="Id"]/../div[1]/div/input
    Should Be Equal    ${windowTaskName}    ${initialTaskName}
    ${windowTital}=    Set Variable    //div[@class="x-window-tl"]//span[text()="Check Out Task #${Task_ID}"]
    Compare Text In Specific Xpath    ${windowTital}    Check Out Task #${Task_ID}
    Click Element    xpath=//button[text()="Check Out"]

Move Task From Done To Check Out Check ID Before Click Done
    [Arguments]    ${Story_ID}    ${Task_ID}    ${initialTaskName}
    Click Element    //table[@class="x-table-layout"]//div[@id="${Story_ID}_closed"]
    Drag and Drop    xpath=//div[@id="${Story_ID}_closed"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${Task_ID}"]    target=${Story_ID}_assigned
    ${windowTaskName}=    Get Value    //input[@name="Id"]/../div[1]/div/input
    Should Be Equal    ${windowTaskName}    ${initialTaskName}
    ${windowTital}=    Set Variable    //div[@class="x-window-tl"]//span[text()="Re Opened Task #${Task_ID}"]
    Compare Text In Specific Xpath    ${windowTital}    Re Opened Task #${Task_ID}
    Click Element    xpath=//button[text()="Re Open"]

Move Task From Check Out To Not Check Out Check ID Before Click Done
    [Arguments]    ${Story_ID}    ${Task_ID}    ${initialTaskName}
    Click Element    //table[@class="x-table-layout"]//div[@id="${Story_ID}_closed"]
    Drag and Drop    xpath=//div[@id="${Story_ID}_assigned"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${Task_ID}"]    target=${Story_ID}_new
    ${windowTaskName}=    Get Value    //input[@name="Id"]/../div[1]/div/input
    Should Be Equal    ${windowTaskName}    ${initialTaskName}
    ${windowTital}=    Set Variable    //div[@class="x-window-tl"]//span[text()="Reset Checked Out Task #${Task_ID}"]
    Compare Text In Specific Xpath    ${windowTital}    Reset Checked Out Task #${Task_ID}
    Click Element    xpath=//button[text()="Reset Check Out"]

Estimate Should Be Required In Sprint Backlog
    [Documentation]    Check the input of estimate is required while adding the new story in Sprint Backlog.
    Wait Until Keyword Succeeds    15    1    Click Button    //button[text()="Add Story"]
    Input Text    //textarea[@name="Name"]    Story for Estimate
    ${value}=    Set Variable    //input[@name="Value"]
    ${estimate}=    Set Variable    //input[@name="Estimate"]
    Input Text    ${value}    3
    ${addStorySubmit}=    Find Current Window Element    Add New Story    Submit
    Focus    ${estimate}
    Double Click Element    ${value}
    Clear Element Text    ${value}
    Element Class Should Be Disabled    ${addStorySubmit}/..
    Input Text    ${estimate}    3
    Element Class Should Be Enabled    ${addStorySubmit}/..
    Click Element    ${addStorySubmit}

TaskCard Remains Should Be Readonly
    [Documentation]    Check the input of remains is readonly in *Not Checked Out State* or *Done State*.
    ${taskEditImg}=    Set Variable    //h2[text()="[Task] \ #${tcTaskID}"]/../..//img[@src="images/edit.png"]
    Wait Until Keyword Succeeds    15    1    Click Element    ${taskEditImg}
    ${remains}=    Set Variable    //input[@name="Remains"]
    Double Click Element    ${remains}
    ${remainsClass}=    Get Element Attribute    ${remains} @readonly
    Should Be Equal    ${remainsClass}    true
    ${editTaskCancel}=    Find Current Window Element    Edit Task #${tcTaskID}    Cancel
    Click Element    ${editTaskCancel}

TaskCard Remains Should Not Be Zero In Checked Out State
    [Documentation]    Check the input of remains can't input zero in *Checked Out State*.
    ${taskEditImg}=    Set Variable    //h2[text()="[Task] \ #${tcTaskID}"]/../..//img[@src="images/edit.png"]
    ${remains}=    Set Variable    //input[@name="Remains"]
    Wait Until Keyword Succeeds    15    1    Click Element    ${taskEditImg}
    Double Click Element    ${remains}
    ${remainsClass}=    Get Element Attribute    ${remains} @readonly
    Should Be Equal As Strings    ${remainsClass}    None
    Input Text    ${remains}    0
    ${editTaskSubmit}=    Find Current Window Element    Edit Task #${tcTaskID}    Submit
    Click Element    ${editTaskSubmit}
    Wait Until Keyword Succeeds    15    1    Alert Should Be Present    The value of remains can not be zero.
    Compare Field Content    ${remains}    3
    ${isSubmitVisible}=    Run Keyword And Return Status    Element Should Be Visible    ${editTaskSubmit}
    Run Keyword If    ${isSubmitVisible}    Click Element    ${editTaskSubmit}

Move Task
    [Arguments]    ${_ThisState}    ${_TargetState}    ${_StoryID}    ${_TaskID}
    ${thisStateID}=    Set Variable If    '${_ThisState}' == 'Not Checked Out'    new    '${_ThisState}' == 'Checked Out'    assigned    '${_ThisState}' == 'Done'
    ...    closed
    ${targetStateID}=    Set Variable If    '${_TargetState}' == 'Not Checked Out'    new    '${_TargetState}' == 'Checked Out'    assigned    '${_TargetState}' == 'Done'
    ...    closed
    Wait Until Keyword Succeeds    15    1    Drag And Drop    xpath=//div[@id="${_StoryID}_${thisStateID}"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${_TaskID}"]    target=${_StoryID}_${targetStateID}
    ${ButtonText}=    Set Variable If    '${_ThisState}' == 'Not Checked Out' and '${_TargetState}' == 'Checked Out'    'Check Out'    '${_ThisState}' == 'Checked Out' and '${_TargetState}' == 'Done'    'Done'    '${_ThisState}' == 'Done' and '${_TargetState}' == 'Checked Out'
    ...    'Re Open'    '${_ThisState}' == 'Checked Out' and '${_TargetState}' == 'Not Checked Out'    'Reset Check Out'
    Wait Until Keyword Succeeds    15    1    Click Button    //button[text()=${ButtonText}]
    Wait Until Page Contains    Success.

TaskCard ReOpen Remains Should Be Last Remains
    [Arguments]    ${_LastRemains}
    ${taskCardValue}=    Set Variable    //td[@class="TaskCard_Value"]
    Compare Text In Specific Xpath    ${taskCardValue}    ${_LastRemains} hr
    ${taskEditImg}=    Set Variable    //h2[text()="[Task] \ #${tcTaskID}"]/../..//img[@src="images/edit.png"]
    ${remains}=    Set Variable    //input[@name="Remains"]
    Wait Until Keyword Succeeds    15    1    Click Element    ${taskEditImg}
    Double Click Element    ${remains}
    Compare Field Content    ${remains}    ${_LastRemains}
    ${editTaskCancel}=    Find Current Window Element    Edit Task #${tcTaskID}    Cancel
    Click Element    ${editTaskCancel}

Check If Remains Changed Then TaskCard Can Not ReCheckOut
    [Arguments]    ${_StoryID}    ${_TaskID}
    Wait Until Keyword Succeeds    15    1    Drag And Drop    xpath=//div[@id="${_StoryID}_assigned"]//table[@class="TaskCard_Header"]//td[2]/h2[text()="[Task]\ \ #${_TaskID}"]    target=${_StoryID}_new
    Element Should Not Be Visible    xpath=//button[text()="Reset Check Out"]
