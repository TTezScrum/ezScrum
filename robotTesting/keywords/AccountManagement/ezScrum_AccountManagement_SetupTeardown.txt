*** Settings ***
Library           ../lib/Selenium2Improved.py
Resource          ../common_resource.txt
Resource          ezScrum_AccountManagement_Management.txt
Resource          ../ezScrum_Login.txt
Resource          ../Project/ezScrum_Project.txt

*** Keywords ***
Test Account Management - PreCondition
    Comment    Login Page    ${LOGIN_URL}
    Comment    Wait Until Page Contains Element    createProjectBtn
    Comment    ${_IsProjectIDExisted}=    Check ProjectID Is Existed    ${PROJECT_NAME}
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="false"    Create Project
    Comment    Run Keyword If    "${_IsProjectIDExisted}"=="true"    Select Project    ${PROJECT_NAME}DisplayName
    Comment    #    Wait Until Page Contains    ${PROJECT_NAME}DisplayName
    Comment    Clean Accounts
    Comment    Logon ezScrum System
    Comment    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}

Test Account Management - PostCondition
    Comment    Login With Admin
    Comment    Clean Accounts
    Comment    Exit ezScrum System
    Comment    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}

_ClickManagmentElement
    [Arguments]    ${userName}
    SwitchToPage    Management
    Run Keyword if    "${userName}"=="admin"    Wait Until Page Contains Element    xpath=//div[@id="Management_Top_Panel"]//td[text()="Account Management"]
    Run Keyword Unless    "${userName}"=="admin"    Wait Until Page Contains Element    xpath=//ul[@class="x-tree-root-ct x-tree-no-lines"]/div//li/ul/li/div[.//span="User Information"]
    Run Keyword if    "${userName}"=="admin"    Wait Until Page Contains Element    xpath=//div[@id="Account_Management_Grid_Panel"]//td[1]/div[text()="${userName}"]
    Run Keyword Unless    "${userName}"=="admin"    Wait Until Page Contains Element    xpath=//div[@id="userEditInformationTab"]//input[@name="id"]

_Logon
    Clean Accounts
    Logon ezScrum System

Test Account Management - Add Account Setup
    Comment    Login With Admin
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Add_Account.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Add_Account.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin

Test Account Management - Add Account Teardown
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Test Account Management - Add Duplicate Account Setup
    Comment    Login With Admin
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Add_Duplicate_Account.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Add_Duplicate_Account.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin

Test Account Management - Add Duplicate Account Teardown
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Test Account Management - Edit Account Setup
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    Add Account By Parameter    ${tsAccountId}    ${tsAccountName}    ${tsAccountMail}
    Comment    Wait Until Page Contains    Success.
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Edit_Account.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Edit_Account.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin

Test Account Management - Edit Account Teardown
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Test Account Management - Delete Account Setup
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Delete_Account.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Delete_Account.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin

Test Account Management - Delete Account Teardown
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Comment    Exit ezScrum System
    Close Browser
    Close All Browsers

Test Account Management - Enable Account Setup
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    Add Account By Parameter    ${tsAccountId}    ${tsAccountName}    ${tsAccountMail}
    Comment    Wait Until Page Contains    Success.
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Enable_Account.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Enable_Account.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin

Test Account Management - Enable Account Teardown
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Test Account Management - Click Add Account Can Display Correct Information Setup
    Comment    Login With Admin
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Click_Add_Account_Can_Display_Correct_Information.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Click_Add_Account_Can_Display_Correct_Information.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin
    Set Test Variable    ${tcAccountID}    account
    Comment    Add Account By Parameter    ${tcAccountID}1    ${tcAccountID}1    ${tcAccountID}1@mail.com
    Comment    Add Account By Parameter    ${tcAccountID}2    ${tcAccountID}2    ${tcAccountID}2@mail.com

Test Account Management - Click Add Account Can Display Correct Information Teardown
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Do Not Delete Account of Admin Setup
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    Set Test Variable    ${tcAccountID}    testAccount
    Comment    Add Account By Parameter    ${tcAccountID}1    ${tcAccountID}1    ${tcAccountID}1@mail.com
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Do_Not_Delete_Account_of_Admin.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Do_Not_Delete_Account_of_Admin.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin
    Set Test Variable    ${tcAccountID}    testAccount
    Add Account By Parameter    ${tcAccountID}1    ${tcAccountID}1    ${tcAccountID}1@mail.com

Do Not Delete Account of Admin Teardown
    Comment    Set Selenium Speed    ${SELENIUM_SPEED}
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Test Account Management - Change Password Setup
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Change_Password.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Change_Password.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin
    Add Account By Parameter    ${tsAccountId}    ${tsAccountName}    ${tsAccountMail}
    Wait Until Page Contains    Success.

Test Account Management - Change Password Teardown
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Comment    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Comment    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Test Account Management - Validate Confirm Password Setup
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    #setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Validate_Confirm_Password.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Validate_Confirm_Password.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin
    Add Account By Parameter    ${tsAccountId}    ${tsAccountName}    ${tsAccountMail}
    Wait Until Page Contains    Success.

Test Account Management - Validate Confirm Password Teardown
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Test Account Management - User Modify Personal Information Setup
    # 建立新使用者
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    User_Modify_Personal_Information.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    User_Modify_Personal_Information.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}
    _ClickManagmentElement    admin
    Add Account By Parameter    ${tsAccountId}    ${tsAccountName}    ${tsAccountMail}
    Wait Until Page Contains    Success.
    # 登出系統
    Logon ezScrum System
    # 以新使用者登入系統
    Login Page With Account In The Same Browser    ${tsAccountId}    ${tsAccountId}
    _ClickManagmentElement    ${tsAccountId}

Test Account Management - User Modify Personal Information Teardown
    Comment    Login With Admin
    Comment    _ClickManagmentElement    admin
    Comment    _Logon
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System

Test Account Manaement - Admin's email shouldn't be null Setup
    Open Browser    ${LOGIN_URL}    ${BROWSER}
    ${attachFilePath}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    AccountManagement    Admin's_Email_Shouldn't_Be_Null.sql
    Load Database    ${DB_URL}    ${DB_NAME}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath}
    ${attachFilePath2}=    Catenate    SEPARATOR=\\    ${EXECDIR}    TestData    Account Microservice    Admin's_Email_Shouldn't_Be_Null.sql
    Load Database    ${DB_URL}    account_ms    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${attachFilePath2}
    Maximize Browser Window
    _InputLoginForm    ${userName}    ${userPassword}

Test Account Manaement - Admin's email shouldn't be null Teardown
    Clean DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    ${DB_NAME}
    Clean Microservice DB    ${DB_URL}    ${DB_ACCOUNT}    ${DB_PASSWORD}    account_ms
    Exit ezScrum System
